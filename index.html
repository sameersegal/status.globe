<!DOCTYPE html>
<html lang="en">
<head>
 <link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body width="100%" height="100%">

<div class="navbar">
  <div class="navbar-inner">
    <div class="container">
 
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
 
      <!-- Be sure to leave the brand out there if you want it shown -->
      <a class="brand" href="#">Status Globe</a>
 
      <!-- Everything you want hidden at 940px or less, place within here -->
      <div class="nav-collapse">
        <!-- .nav, .navbar-search, .navbar-form, etc -->
      </div>
 
    </div>
  </div>
</div>

<div class="row" style="padding:0 30px; min-height: 600px">
  <div class="span11 pull-left" style="height: 600px; background: #F5f5f5; border: 1px solid #DDD; border-radius: 8px;">    
    <svg id="playground" xmlns="http://www.w3.org/2000/svg" version="1.1" height="100%" width="100%"></svg>
  </div>
  <div class="span4 pull-right" style="height: 600px; background: #F5f5f5; border: 1px solid #DDD; border-radius: 8px;">
      // chat history
  </div>
</div>


<script type="text/template" id="login">
   <label>Name</label><input type="text" name="name" />
   <label>Status</label><input type="text" name="status" />
</script>

<script type="text/template" id="user">
   <text x="100" y="50" stroke="black" stroke-width="2" "text-anchor"="middle" dx="-15">Boo</text>
</script>

<!-- backbone, underscore -->
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="/js/jquery-1.8.2.min.js"></script>
<script type="text/javascript"src="/js/underscore.js"></script>
<script type="text/javascript"src="/js/backbone-min.js"></script>
<script type="text/javascript" src="/js/underscore.js"></script>
<script type="text/javascript" src="/js/backbone-min.js"></script>
<script type="text/javascript" src="/js/d3.v2.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/keyboard.0.2.2.min.js"></script>

<script type="text/javascript">

var socket = io.connect('http://sreeix.status.globe.jit.su');
var userCollection;
var step = 35;
var myusername = "Sameer";



  socket.on('user_move', function (data) {
    userCollection.userMove(data);
    });

    socket.on('user_join', function (data) {
    userCollection.userJoin(data);
    });

function socket_user_move(data) {
    socket.emit("user_move",data);
}

function socket_user_join(data) {
    socket.emit("user_join",data);
}

var User = Backbone.Model.extend({

  defaults: {
    x : 100,
    y : 50,
    r : 40,
    name: "Boo"
  },

  initialize: function(){

  },

  updateLocation: function(xf,yf){
    this.set({
      x: this.get("x") + xf*step,
      y: this.get("y") + yf*step
      //r: d3.max([2, this.get("r") + (Math.random() - 0.5)*20]),
    });
  }

});

var UserCollection = Backbone.Collection.extend({
  model: User,

  userJoin: function(data){
    var m = this.findUser(data.name);
    if( !m || m.length == 0 ) {
      this.add(new User(data));
    }
  },

  userMove: function(data){
    var m = this.findUser(data.name);
    if( m && m.length > 0 ) {
      m = m[0];
      m.set(data);
    }
  },

  findUser: function(username){
    return _.filter(this.models, function(d){
      return d.get("name") === username;
    });
  }
});

var PlaygroundView = Backbone.View.extend({

   el: "#playground",

   initialize: function() {
     this.collection.on("all",this.render,this);
      this.render();
   },

   render: function () {

      var data = this.collection.models;

      d3.select(this.el)
      .selectAll("circle")
      .data(data, function(d) { return d.get("name")})
      .enter()
      .append("circle")
      .attr("cx",function(d){ return d.get("x")})
      .attr("cy",function(d){ return d.get("y")})
      .attr("r",function(d){ return d.get("r")});

      d3.select(this.el)
      .selectAll("circle")
      .data(data, function(d) { return d.get("name")})
      .transition()
      .duration(750)
      .attr("cx",function(d){ return d.get("x")})
      .attr("cy",function(d){ return d.get("y")})
      .attr("r",function(d){ return d.get("r")});

      d3.select(this.el)
      .selectAll("circle")
      .data(data, function(d) { return d.get("name")})
      .exit()
      .remove();
   }

});

$(function(){

   KeyboardJS.bind.key('up, down, left, right',
    function(arg1, arg2, key) {
      var me = userCollection.findUser(myusername);
      if(me) {

        me = me[0];

        switch(key){
          case "up":
            me.updateLocation(0,-1);
          break;
          case "down":
            me.updateLocation(0,+1);
          break;
          case "left":
            me.updateLocation(-1,0);
          break;
          case "right":
            me.updateLocation(1,0);
          break;
        }

        socket_user_move(me.toJSON());
      }

    }, function() {

      // TODO ...
    });

   userCollection = new UserCollection();
   
   var user1 = new PlaygroundView({collection: userCollection});

   socket_user_join({name: "Sameer",x:100,y:50});
   socket_user_join({name: "Sreekanth",x:50,y:100});
 
});
</script>
</body>
</html>